---
title: "A global database on animal biodiversity measured in different grazing treatments"
author: "Alessandro Filazzola & Tianna Barber-Cross"
date: "6/19/2020"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
editor_options: 
  chunk_output_type: console
---
<br>  


![](./grazing.jpg)


### Load Libraries and Data
```{r warning=FALSE, message=FALSE}
## Load libraries
library(tidyverse)
library(ggthemes)

## Load functions
source("scripts//figureFormat.r")

## Load data on study information
studyData <- read.csv("data//StudyData.csv", stringsAsFactors = F)

## load all data on grazing and merge with simplified datasets
data <- read.csv("data//grazingData.csv", stringsAsFactors = F)
est <- read.csv("data//simpleCategories//estimateCategories.csv", stringsAsFactors = F)
graze <- read.csv("data//simpleCategories//grazingCategories.csv", stringsAsFactors = F)
data <- merge(data, est, by="Estimate", stringsAsFactors = F)
data <- merge(data, graze, by="grazing.estimate", stringsAsFactors = F)

```

### A distribution of where the studies took place
```{r warning=FALSE, message=FALSE}

## Remove sites without lat lon
gps <- studyData %>% filter(lat != "")

### Split multiple GPS coordinates for the same site
gpsSplit <- gps %>%   transform(lon = strsplit(lon, ";")) %>%   transform(lat = strsplit(lat, ";"))  %>%   unnest(lon, lat) %>% ## unnest lat/lon 
  mutate(lat = as.numeric(lat), lon=as.numeric(lon))


require(ggmap)
require(maps)
###  Start with base map of world
mp <- NULL
mapWorld <- borders("world", colour="gray50", fill="gray75") # create a layer of borders
mp <- ggplot() + theme_bw()+  mapWorld

mp <- mp+ geom_point(data=gpsSplit %>%  filter(grazer.status != "") , aes(x=lon, y=lat, fill=grazer.status), size=2, pch=21) + scale_fill_manual(values=c("#D55E00", "#E69F00", "#56B4E9","grey50")) + ylab("Latitude") + xlab("Longitude")
mp

```


### Visualize patterns among studies
```{r warning=FALSE, message=FALSE}
## Replicates
names(studyData)
plot1 <- ggplot(studyData, aes(x = as.numeric(n.sites))) + geom_density(fill="Grey50") + theme_Publication() + xlab("Number of sites") + ylab("Frequency of studies") + scale_x_continuous(trans =  "log2")

plot2 <- ggplot(studyData, aes(x = as.numeric(study.duration))) + geom_density(fill="Grey50") + theme_Publication() + xlab("Duration of study in years") + ylab("Frequency of studies")+ scale_x_continuous(trans =  "log2")

gridExtra::grid.arrange(plot1, plot2, ncol=2)
```

### Pattern among Vegetation Classes
```{r warning=FALSE, message=FALSE}
## Split by semi-colon
unnestVeg <- studyData %>%   unnest(veg.class = strsplit(veg.class, ";"))
## Summarize by each class
VegClass <- unnestVeg %>% group_by(veg.class) %>% summarize(n=length(veg.class)) %>% filter(!is.na(veg.class))

ggplot(VegClass, aes(x=veg.class, y=n)) + geom_bar(stat="identity") + theme_Publication() + xlab("") + ylab("Number of studies") + coord_flip()

```

### Most common grazers
```{r warning=FALSE, message=FALSE}
## Split by semi-colon
unnestGraze <- studyData %>%   unnest(herbivores = strsplit(herbivores, ";"))
## Summarize by each class
herbsum <- unnestGraze %>% group_by(herbivores) %>% summarize(n=length(herbivores)) %>% filter(!is.na(herbivores)) 

topherb <- herbsum %>% top_n(20) %>% arrange(-n) ## select 10 most commonly surveyed
topherb

ggplot(topherb, aes(x=reorder(herbivores, -n), y=n)) + geom_bar(stat="identity") + theme_Publication() + xlab("") + ylab("Number of studies") + coord_flip()

```

### Summary statistics of other categories
```{r warning=FALSE, message=FALSE}
studyData %>% group_by(openvsfenced) %>% summarize(n=length(uniqueID))
studyData %>% group_by(tilledvsleftalone) %>% summarize(n=length(uniqueID))
studyData %>% group_by(fire) %>% summarize(n=length(uniqueID))
studyData %>% group_by(fertilization) %>% summarize(n=length(uniqueID))

```

### Comparisons of binary variables
```{r}
source("scripts//meta.evalSE.r")



## Load packages and functions
library(reshape2)
library(metafor)
source("meta.evalSE.r") ## Multiple aggregate


## Reference data
meta <- data

## Create Unique identifier column
meta[,"UniqueSite"] <- paste(meta$uniqueID, meta$Higher.Taxa, meta$Taxa, meta$Estimate, meta$siteID, sep="-")

## convert se to sd
meta[meta$Stat=="StDev","Value"] <- meta[meta$Stat=="StDev","Value"] / sqrt(as.numeric(meta[meta$Stat=="StDev","replicate"] ))
meta[meta$Stat=="StDev","Stat"] <- "SE"

## drop comparisons that are not pairwise
meta <-  meta %>% filter(grazing.compare  == "ordinal/binary")

## Use function to extract summary statistics for comparisons
## meta.eval  arguments are (meta.data, compare, ids , stats)
grazed.compare <- meta.eval(meta, grazing.level, UniqueSite, Stat)

## Combine the lists into same dataframe
## Rename Columns in second dataframe
grazed.stat <- grazed.compare [[2]] ## extracted statistics 
names(grazed.stat) <- c("UniqueSite","grazed_mean","grazed_se","ungrazed_mean","ungrazed_se","grazed_n","ungrazed_n") ## rename columns to match
grazed.raw <- grazed.compare[[1]] ## calculated statistics from raw values

## Join two dataframes
meta.stat <- rbind(grazed.raw, grazed.stat[, names(grazed.raw)])

## Calculate effect size from SE rather than SD. To calculate variance treat replicates as 1. 
## https://stats.stackexchange.com/questions/152172/meta-analysis-in-r-with-standard-errors-instead-of-standard-deviations-metafor 
meta.stat[,"dummyN"] <- 1
meta.ready <- escalc(n1i = dummyN, n2i = dummyN, m1i = ungrazed_mean, m2i = grazed_mean, sd1i = ungrazed_se, sd2i = grazed_se, data = meta.stat, measure = "ROM", append = TRUE)
  
```







